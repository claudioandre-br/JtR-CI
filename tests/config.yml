version: 2
jobs:
  common_linux: &common_linux
    docker:
      - image: ghcr.io/claudioandre-br/john-ci:fedora.37
    steps:
      - checkout
      - run:
          name: Building JtR
          command: .ci/tests-ci.sh $TARGET_ARCH BUILD
      - run:
          name: Testing JtR
          command: .ci/tests-ci.sh $TARGET_ARCH TEST

  linux-Ubuntu-Dev:
    <<: *common_linux
    docker:
      - image: ghcr.io/claudioandre-br/john-ci:ubuntu.devel
        environment:
          TARGET_ARCH: "NIX"
          EXTRA: "full;extra;crack;"
          OMP_NUM_THREADS: 2

  linux-Fedora:
    <<: *common_linux
    docker:
      - image: ghcr.io/claudioandre-br/john-ci:fedora.37
        environment:
          TARGET_ARCH: "NIX"
          EXTRA: "full;extra;crack;"
          OMP_NUM_THREADS: 2

  make-check:
    <<: *common_linux
    docker:
      - image: ghcr.io/claudioandre-br/john-ci:fedora.37
        environment:
          TARGET_ARCH: "NIX"
          EXTRA: "CHECK;"
          ASAN: "--enable-asan"
          OMP_NUM_THREADS: 3

  no-omp:
    <<: *common_linux
    docker:
      - image: ghcr.io/claudioandre-br/john-ci:fedora.37
        environment:
          TARGET_ARCH: "NIX"
          EXTRA: "full;extra;crack;"
          BUILD_OPTS: "--disable-openmp" # disabled temporarily -enable-werror 

  no-simd:
    <<: *common_linux
    docker:
      - image: ghcr.io/claudioandre-br/john-ci:fedora.37
        environment:
          TARGET_ARCH: "NIX"
          EXTRA: "full;extra;crack;"
          BUILD_OPTS: "-enable-werror --disable-simd"
          OMP_NUM_THREADS: 2

  no-simd-omp:
    <<: *common_linux
    docker:
      - image: ghcr.io/claudioandre-br/john-ci:fedora.37
        environment:
          EXTRA: "full;extra;crack;"
          TARGET_ARCH: "NIX"
          BUILD_OPTS: "-enable-werror --disable-simd --disable-openmp"

  omp-fast-formats:
    <<: *common_linux
    docker:
      - image: ghcr.io/claudioandre-br/john-ci:fedora.37
        environment:
          TARGET_ARCH: "NIX"
          EXTRA: "full;extra;crack;"
          BUILD_OPTS: "--enable-openmp-for-fast-formats --enable-simd=avx2" # disabled temporarily -enable-werror 
          OMP_NUM_THREADS: 2

  compare-simd:
    <<: *common_linux
    docker:
      - image: ghcr.io/openwall/john
        user: root
        environment:
          TARGET_ARCH: "DOCKER"
          EXTRA: "SIMD"
          OMP_NUM_THREADS: 2

  flatpak:
    machine:
      image: ubuntu-2204:current
    environment:
      OMP_NUM_THREADS: 2
      TEST: ";full;extra;"
      arch: "x86_64"
      JTR_BIN: "flatpak run com.openwall.John"
      JTR_CL: "flatpak run com.openwall.John"

    steps:
      - run: env
      - run: sudo apt-get update && sudo apt-get install -y flatpak
      - run: wget https://github.com/openwall/john-packages/releases/download/jumbo-dev/flatpak_1_JtR.zip
      - run: unzip flatpak_1_JtR.zip && ls -l
      - run: flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
      - run: flatpak install -y flathub org.freedesktop.Platform//22.08
      - run: flatpak install --user -y --bundle john.flatpak
      - run: flatpak run com.openwall.John
      - run: flatpak run com.openwall.John --list=build-info
      - run: pwd && ls -l && ../tests/run_tests.sh
      - run: cowsay Continuous Integration Rocks!

workflows:
  version: 2
  build:
    jobs:
      - linux-Ubuntu-Dev
      - linux-Fedora
      - make-check
      - extras:
          type: approval
      - compare-simd:
          requires:
            - extras
      - flatpak:
          requires:
            - extras
      - no-omp
      - no-simd-omp:
          requires:
            - no-omp
      - no-simd
      - omp-fast-formats:
          requires:
            - linux-Fedora
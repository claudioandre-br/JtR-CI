version: 2
jobs:
  common_linux: &common_linux
    docker:
      - image: ghcr.io/claudioandre-br/john-ci:fedora.37
    steps:
      - checkout
      - run:
          name: Building JtR
          command: .ci/tests-ci.sh $TARGET_ARCH BUILD
      - run:
          name: Testing JtR
          command: .ci/tests-ci.sh $TARGET_ARCH TEST

  linux-Ubuntu-Dev:
    <<: *common_linux
    docker:
      - image: ghcr.io/claudioandre-br/john-ci:ubuntu.devel
        environment:
          TARGET_ARCH: "NIX"
          EXTRA: "full;extra;crack;"
          OMP_NUM_THREADS: 2

  linux-Fedora:
    <<: *common_linux
    docker:
      - image: ghcr.io/claudioandre-br/john-ci:fedora.37
        environment:
          TARGET_ARCH: "NIX"
          EXTRA: "full;extra;crack;"
          OMP_NUM_THREADS: 2

  make-check:
    <<: *common_linux
    docker:
      - image: ghcr.io/claudioandre-br/john-ci:fedora.37
        environment:
          TARGET_ARCH: "NIX"
          EXTRA: "CHECK;"
          ASAN: "--enable-asan"
          OMP_NUM_THREADS: 3

  no-omp:
    <<: *common_linux
    docker:
      - image: ghcr.io/claudioandre-br/john-ci:fedora.37
        environment:
          TARGET_ARCH: "NIX"
          EXTRA: "full;extra;crack;"
          BUILD_OPTS: "--disable-openmp" # disabled temporarily -enable-werror

  no-simd:
    <<: *common_linux
    docker:
      - image: ghcr.io/claudioandre-br/john-ci:fedora.37
        environment:
          TARGET_ARCH: "NIX"
          EXTRA: "full;extra;crack;"
          BUILD_OPTS: "-enable-werror --disable-simd"
          OMP_NUM_THREADS: 2

  no-simd-omp:
    <<: *common_linux
    docker:
      - image: ghcr.io/claudioandre-br/john-ci:fedora.37
        environment:
          EXTRA: "full;extra;crack;"
          TARGET_ARCH: "NIX"
          BUILD_OPTS: "-enable-werror --disable-simd --disable-openmp"

  omp-fast-formats:
    <<: *common_linux
    docker:
      - image: ghcr.io/claudioandre-br/john-ci:fedora.37
        environment:
          TARGET_ARCH: "NIX"
          EXTRA: "full;extra;crack;"
          BUILD_OPTS: "--enable-openmp-for-fast-formats --enable-simd=avx2" # disabled temporarily -enable-werror
          OMP_NUM_THREADS: 2

  compare-simd:
    <<: *common_linux
    docker:
      - image: ghcr.io/openwall/john
        user: root
        environment:
          TARGET_ARCH: "DOCKER"
          EXTRA: "SIMD"
          OMP_NUM_THREADS: 2

  flatpak:
    machine:
      image: ubuntu-2204:current
    environment:
      OMP_NUM_THREADS: 2
      TEST: ";full;extra;"
      arch: "x86_64"
      JTR_BIN: "flatpak run com.openwall.John"

    steps:
      - run:
          name: Initialising
          command: |
            sudo apt-get update && sudo apt-get install -y flatpak
            wget https://github.com/openwall/john-packages/releases/download/jumbo-dev/flatpak_1_JtR.zip
            unzip flatpak_1_JtR.zip
            sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
            sudo flatpak install -y flathub org.freedesktop.Platform//22.08
            flatpak install --user -y --bundle john.flatpak
      - run:
          name: System Information
          command: |
            flatpak run com.openwall.John
            flatpak run com.openwall.John --list=build-info
      - run:
          name: Testing
          command: |
            wget https://raw.githubusercontent.com/claudioandre-br/JtR-CI/master/tests/run_tests.sh
            source run_tests.sh

  Mac-OS:
    macos:
      xcode: 14.2.0
    environment:
      TARGET_ARCH : "MacOS"
      EXTRA: "full;extra"
      BUILD_OPTS: "--disable-native-tests --enable-simd=avx"
      CC : "clang"
      TEST : "MacOS;"
      BASE : "Apple MacOS"

    steps:
      - run:
          name: Checkout code
          command: |
            git clone --depth 10 https://github.com/openwall/john.git ~/tmp
            cp -r ~/tmp/. .
            wget https://raw.githubusercontent.com/claudioandre-br/JtR-CI/master/tests/tests-ci.sh -O .ci/tests-ci.sh
            chmod +x .ci/tests-ci.sh
      - run:
          name: Building JtR
          command: .ci/tests-ci.sh $TARGET_ARCH BUILD
      - run:
          name: Testing JtR
          command: .ci/tests-ci.sh $TARGET_ARCH TEST
      - run:
          name: Cleaning
          command: rm -rf src .git .ci .circleci .azure .editorconfig .gitattributes .github .gitignore .mailmap .pre-commit.sh .travis .travis.yml && rm -rf run/ztex
      - run:
          name: Saving package
          command: |
            zip -vr -9 ../JtR.zip ./
            sha256sum ../*.zip

      - store_artifacts:
          path: ../JtR.zip
          destination: JtR.zip

workflows:
  version: 2
  build:
    jobs:
      - linux-Ubuntu-Dev
      - make-check
      - no-simd

      - no-omp
      - no-simd-omp:
          requires:
            - no-omp

      - linux-Fedora
      - omp-fast-formats:
          requires:
            - linux-Fedora

      - mac-package:
          type: approval
      - Mac-OS:
          requires:
            - mac-package

      - extras:
          type: approval
      - compare-simd:
          requires:
            - extras
      - flatpak:
          requires:
            - extras
